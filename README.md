# Backend Auction Challenge — Gift Auctions (демо)

Этот репозиторий — реализация многораундового аукциона цифровых товаров для демонстрации корректной бизнес‑логики, конкурентности и поведения системы под нагрузкой.

- Демонстрация работы: https://disk.yandex.ru/i/-Vv_HKNwi2s2_w

---

## 1 Механика аукциона

### 1.1 Многораундовость

- Аукцион состоит из roundsTotal раундов.
- Всего разыгрывается totalItems подарков.
- В каждом раунде разыгрывается itemsPerRound = totalItems / roundsTotal.
- По окончании раунда победителями становятся участники, занявшие топ itemsPerRound в лидерборде текущего раунда.
- Те, кто не выиграл в этом раунде, продолжают участие в следующих раундах.

### 1.2 Ставки и ранжирование

- Ставка пользователя — его текущая максимальная ставка в рамках аукциона.
- Повышение ставки возможно только вверх.
- Ранжирование: выше ставка → выше место.
- Tie‑breaker при равной ставке: более ранняя ставка имеет приоритет.

### 1.3 Деньги (Wallet)

- У пользователя есть кошелёк.
- При повышении ставки блокируется только дельта: newBid - oldBid.
- При выигрыше раунда заблокированные средства списываются.
- В конце аукциона всем невыигравшим участникам оставшиеся заблокированные средства разблокируются (refund).

### 1.4 Anti‑sniping (продление раунда)

- Если ставка сделана ближе, чем AUCTIONS_ANTI_SNIPING_THRESHOLD_MS до конца раунда, раунд продлевается на AUCTIONS_ANTI_SNIPING_EXTENSION_SEC секунд.
- Продление реализовано так, чтобы не создавать лишнюю нагрузку на MongoDB: время окончания раунда обновляется только при реальной необходимости (условное обновление).

---

## 2 Архитектурные решения

### 2.1 Mongo + Redis

- MongoDB хранит состояние аукциона (параметры, статус, текущий раунд, время окончания), а также историю победителей по раундам.
- Redis хранит лидерборд ставок в Sorted Set, чтобы быстро получать:
  - топ N участников,
  - место конкретного пользователя,
  - значения ставок.

### 2.2 Модули

- users: создание пользователя.
- wallets: кошелёк и финансовые операции (deposit / lock / unlock / charge).
- auctions: создание/старт аукциона, прием ставок, лидерборд, round settlement, история победителей.
- bots: генерация активности и нагрузочное тестирование.

### 2.3 Background processing

Завершение раунда происходит по времени в фоне, чтобы аукцион корректно двигался независимо от активности клиентов.

### 2.4 CQRS + DDH (Vertical Slice)

Проект использует CQRS-идею: операции изменения состояния оформлены как commands, а чтение — как queries (разделение моделей записи и чтения).
Код организован в стиле DDH/DDD + Vertical Slice: бизнес‑правила находятся в доменных сущностях/VO, а прикладные use‑cases сгруппированы по фичам (команда/запрос/контроллер/DTO рядом), что упрощает развитие и проверку отдельных сценариев.

---

## 3 Боты = нагрузочное тестирование

В проекте есть модуль bots, который используется как встроенное нагрузочное тестирование: он создаёт пользователей, пополняет кошельки и генерирует ставки по стратегиям «фон» + «снайпинг».

### 3.1 Типы ботов

- Normal bots: делают ставки с рандомным интервалом в течение раунда и прекращают за N секунд до конца.
- Sniper bots: создают всплеск ставок за M секунд до конца (проверка anti‑sniping), при этом количество продлений ограничивается.

---

## 4 API (кратко)

Основные эндпоинты:

- POST /api/users
- GET /api/users/:userId
- GET /api/wallets/:walletId
- POST /api/wallets/deposit
- POST /api/auctions
- GET /api/auctions
- GET /api/auctions/:auctionId
- PATCH /api/auctions/:id/start
- POST /api/auctions/:id/bid
- GET /api/auctions/:auctionId/leaderboard?userId=...
- GET /api/auctions/:auctionId/history

---

## 5 Запуск

### 5.1 Требования

- Docker + Docker Compose.

### 5.2 Запуск

```bash
cp apps/backend/.env.example apps/backend/.env
cp apps/frontend/.env.example apps/frontend/.env

# dev
docker compose up --build

# production
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build
```

### 5.3 URLs

- Frontend: http://localhost
- Backend (через nginx proxy): http://localhost/api
- Swagger: http://localhost/api/docs

---

### 6 Переменные, влияющие на нагрузку

- BOTS_ENABLED — включает/выключает запуск ботов (если false, боты не создаются и ставки не генерируются).
- BOTS_NORMAL_COUNT — количество «обычных» ботов, которые создают фоновую активность ставками.
- BOTS_NORMAL_BID_INTERVAL_MS_MIN/MAX — минимальный/максимальный интервал (в мс) между ставками одного обычного‑бота; чем меньше значения, тем выше средняя частота ставок.
- BOTS_SNIPER_COUNT — количество «снайперских» ботов, которые делают ставки в конце раунда.
- BOTS_SNIPER_BURST_SIZE_MIN/MAX — минимальное/максимальное кол-во ставок под завершение раунда; чем больше, тем выше пик нагрузки.
- AUCTIONS_ANTI_SNIPING_THRESHOLD_MS — порог «анти‑снайпинга» в миллисекундах: если ставка сделана ближе к концу, чем это значение, раунд продлевается.
- AUCTIONS_ANTI_SNIPING_EXTENSION_SEC — на сколько секунд продлевается раунд, если сработал anti‑sniping.
